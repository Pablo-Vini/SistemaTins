{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Pedido</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <style>
        .selected {
            background: #eef;
        }

        .endereco {
            display: none;
            margin: 6px 0;
        }

        .endereco.visible {
            display: block;
        }
    </style>
</head>

<body>
    <main>
        <section class="lista_clientes">
            <div>
                <h1>Clientes</h1>
            </div>
            <div id="clientes">
                {% for lc in clientes %}
                <div class="cliente_item" data-cliente-id="{{ lc.id }}" data-cliente-cpf="{{ lc.cpf }}">
                    <div><strong>{{ lc.nome }}</strong></div>
                    <div>CPF: {{ lc.cpf }}</div>
                    <div>{{ lc.email }}</div>
                    <div>{{ lc.telefone }}</div>
                    <div>{{ lc.data_cadastro }}</div>
                </div>
                {% endfor %}
            </div>
            <div><a href="">Voltar</a></div>
        </section>

        <section class="lista_enderecos">
            <div>
                <h1>Endereços</h1>
            </div>
            <div>
                <form id="form-enderecos" action="">
                    <div id="enderecos">
                        {% for le in enderecos %}
                        <label class="endereco" data-cliente="{{ le.cliente }}" data-endereco-id="{{ le.id }}">
                            <input type="radio" name="endereco_radio" value="{{ le.id }}">
                            <strong>{{ le.titulo }}</strong>, {{ le.logradouro }} — {{ le.bairro }} - {{ le.cidade }}/{{
                            le.estado }}
                        </label>
                        {% endfor %}
                    </div>
                </form>
            </div>
        </section>

        <section class="lista_produtos">
            <div class="pesquisa">
                <h1>Produtos</h1>
            </div>
            <div class="lista">
                <nav>
                    <ul id="produtos">
                        {% for lp in produtos %}
                        <li class="produto-item" data-id="{{ lp.id }}" data-codigo="{{ lp.codigo }}"
                            data-descricao="{{ lp.descricao }}" data-valor="{{ lp.valor_unitario }}">
                            {{ lp.codigo }} - {{ lp.descricao }} - R$ {{ lp.valor_unitario }}
                            <button class="btn-add" type="button">Adicionar</button>
                        </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>

            <div class="valor_total">
                <h2>Carrinho</h2>
                <ul id="carrinho"></ul>
                <div>Total: R$ <span id="total">0,00</span></div>
                <button id="enviar">Enviar Pedido</button>
                <div id="msg" style="margin-top:8px;color:green"></div>
            </div>
        </section>
    </main>
</body>

<script>
    (() => {
        let cliente = null;
        let enderecoId = null;
        const carrinho = [];
        const NOVO_PEDIDO_URL = "{% url 'app:novo_pedido' %}";


        const clientesEl = document.getElementById('clientes');
        const enderecosEl = document.getElementById('enderecos');
        const produtosEl = document.getElementById('produtos');
        const carrinhoEl = document.getElementById('carrinho');
        const totalEl = document.getElementById('total');
        const enviarBtn = document.getElementById('enviar');
        const msgEl = document.getElementById('msg');

        function atualizaCarrinho() {
            carrinhoEl.innerHTML = '';
            let total = 0;
            carrinho.forEach((p, i) => {
                const li = document.createElement('li');
                li.textContent = `${p.codigo} x${p.q} — R$ ${p.valor.toFixed(2).replace('.', ',')}`;
                const rm = document.createElement('button');
                rm.textContent = 'Remover';
                rm.type = 'button';
                rm.onclick = () => { carrinho.splice(i, 1); atualizaCarrinho(); };
                li.appendChild(document.createTextNode(' '));
                li.appendChild(rm);
                carrinhoEl.appendChild(li);
                total += p.q * p.valor;
            });
            totalEl.textContent = total.toFixed(2).replace('.', ',');
        }

        clientesEl.addEventListener('click', e => {
            const el = e.target.closest('.cliente_item');
            if (!el) return;
            Array.from(clientesEl.querySelectorAll('.cliente_item')).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            cliente = { id: el.dataset.clienteId, cpf: el.dataset.clienteCpf };

            // Mostrar apenas endereços que tenham le.cliente igual ao cpf do cliente selecionado
            const labels = Array.from(enderecosEl.querySelectorAll('.endereco'));
            labels.forEach(label => {
                if (label.dataset.cliente === cliente.cpf) {
                    label.classList.add('visible');
                    label.querySelector('input').disabled = false;
                } else {
                    label.classList.remove('visible');
                    const inp = label.querySelector('input');
                    inp.checked = false;
                    inp.disabled = true;
                }
            });

            // Seleciona o primeiro endereço visível, se houver
            const firstVisible = enderecosEl.querySelector('.endereco.visible input');
            if (firstVisible) {
                firstVisible.checked = true;
                enderecoId = firstVisible.value;
            } else {
                enderecoId = null;
            }

            msgEl.textContent = '';
        });

        // Delegation para mudança de radio
        enderecosEl.addEventListener('change', e => {
            if (e.target.name === 'endereco_radio') enderecoId = e.target.value;
        });

        // Adicionar produto
        produtosEl.addEventListener('click', e => {
            if (!e.target.classList.contains('btn-add')) return;
            const li = e.target.closest('li.produto-item');
            const id = li.dataset.id;
            const valor = parseFloat(li.dataset.valor.replace(',', '.')) || parseFloat(li.dataset.valor) || 0;
            const codigo = li.dataset.codigo || li.textContent.split(' - ')[0].trim();
            const existente = carrinho.find(p => p.id === id);
            if (existente) existente.q++;
            else carrinho.push({ id, codigo, valor, q: 1 });
            atualizaCarrinho();
        });

        enviarBtn.addEventListener('click', () => {
            msgEl.style.color = 'red';
            if (!cliente) { msgEl.textContent = 'Selecione um cliente.'; return; }
            if (!enderecoId) { msgEl.textContent = 'Selecione um endereço.'; return; }
            if (carrinho.length === 0) { msgEl.textContent = 'Adicione pelo menos um produto.'; return; }

            const payload = {
                cliente_id: cliente.id,
                cliente_cpf: cliente.cpf,
                endereco_id: enderecoId,
                produtos: carrinho.map(p => ({ produto_id: p.id, codigo: p.codigo, quantidade: p.q, valor_unitario: p.valor }))
            };

            const url = NOVO_PEDIDO_URL; // gerada pelo template com {% url %}
            const csrf = document.querySelector('meta[name="csrf-token"]').content;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                body: JSON.stringify(payload)
            })
                .then(r => r.ok ? r.json() : r.json().then(err => Promise.reject(err)))
                .then(data => {
                    msgEl.style.color = 'green';
                    msgEl.textContent = 'Pedido criado. ID: ' + (data.pedido_id || '—');
                    // limpa estado local após sucesso
                    cliente = null;
                    enderecoId = null;
                    carrinho.length = 0;
                    Array.from(clientesEl.querySelectorAll('.cliente_item')).forEach(c => c.classList.remove('selected'));
                    Array.from(enderecosEl.querySelectorAll('.endereco')).forEach(l => {
                        l.classList.remove('visible');
                        const inp = l.querySelector('input');
                        inp.checked = false;
                        inp.disabled = false;
                    });
                    atualizaCarrinho();
                })
                .catch(err => {
                    msgEl.textContent = (err && err.detail) ? err.detail : String(err);
                });
        });
    })();
</script>